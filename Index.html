<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Visor de c√°mara USB</title>
  <style>
    :root {
      --bg: #0b0f14; /* fondo oscuro */
      --fg: #e6edf3; /* texto claro */
      --muted: #93a1b0;
      --accent: #4aa7ff;
      --danger: #ff5d5d;
      --ok: #35d18f;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Arial, sans-serif; }/* Contenedor de video a pantalla completa */
#stage { position: fixed; inset: 0; overflow: hidden; background: #000; }
video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; background: #000; transform: scaleX(1); }
.contain video { object-fit: contain; }
.mirror video { transform: scaleX(-1); }

/* Barra de controles */
#controls { position: fixed; left: 50%; transform: translateX(-50%); bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px; background: rgba(20,24,30,0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.12); padding: 10px; border-radius: 16px; align-items: center; }
#controls button, #controls select, #controls input[type="range"] { appearance: none; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); color: var(--fg); padding: 10px 12px; border-radius: 12px; font-size: 14px; }
#controls button { cursor: pointer; transition: transform 0.06s ease, background 0.2s ease; }
#controls button:hover { transform: translateY(-1px); }
#controls button.primary { background: var(--accent); color: #091017; border-color: transparent; }
#controls button.danger { background: var(--danger); color: #160808; border-color: transparent; }
#controls button.ok { background: var(--ok); color: #04160e; border-color: transparent; }
#controls label { font-size: 12px; color: var(--muted); margin: 0 4px; }

#error { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); max-width: min(92vw, 900px); background: #2a1212; color: #ffd7d7; border: 1px solid #ff8a8a; padding: 10px 12px; border-radius: 12px; display: none; white-space: pre-wrap; }
#hint { position: fixed; top: 12px; right: 12px; font-size: 12px; color: var(--muted); background: rgba(255,255,255,0.06); padding: 6px 8px; border-radius: 10px; }

/* Ocultar cursor tras 3s sin movimiento (modo pro) */
.idle { cursor: none; }

/* Modo m√≥vil: controles m√°s grandes */
@media (max-width: 640px) {
  #controls { bottom: 8px; gap: 6px; padding: 8px; }
  #controls button, #controls select, #controls input[type="range"] { padding: 10px; font-size: 13px; }
  #hint { display: none; }
}

  </style>
</head>
<body>
  <div id="stage" class="cover">
    <video id="video" autoplay playsinline muted></video>
  </div>  <div id="controls" role="group" aria-label="Controles de c√°mara">
    <button id="btnStart" class="primary" title="Iniciar c√°mara (Barra espaciadora)">‚ñ∂Ô∏è Iniciar</button>
    <button id="btnStop" class="danger" title="Detener c√°mara (Barra espaciadora)" disabled>‚èπÔ∏è Detener</button>
    <button id="btnFS" title="Pantalla completa (F)">‚õ∂ Pantalla completa</button>
    <button id="btnMirror" title="Espejo (M)">ü™û Espejo</button>
    <button id="btnFit" title="Ajuste: Contener/Cubrir (C)">üñºÔ∏è Ajuste</button>
    <label for="selCam">C√°mara:</label>
    <select id="selCam" title="Elegir c√°mara"></select>
    <label for="zoom">Zoom:</label>
    <input id="zoom" type="range" min="1" max="1" step="0.01" value="1" disabled />
    <button id="btnTorch" title="Linterna (si disponible)" disabled>üî¶ Linterna</button>
  </div>  <div id="error" role="alert"></div>
  <div id="hint">Atajos: F pantalla completa ¬∑ M espejo ¬∑ C ajuste ¬∑ Barra espaciadora iniciar/detener</div>  <script>
    const video = document.getElementById('video');
    const stage = document.getElementById('stage');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnFS = document.getElementById('btnFS');
    const btnMirror = document.getElementById('btnMirror');
    const btnFit = document.getElementById('btnFit');
    const selCam = document.getElementById('selCam');
    const zoomSlider = document.getElementById('zoom');
    const btnTorch = document.getElementById('btnTorch');
    const errorBox = document.getElementById('error');

    let currentStream = null;
    let currentTrack = null;
    let torchOn = false;
    let wakeLock = null;

    function showError(msg){
      console.error(msg);
      errorBox.textContent = String(msg);
      errorBox.style.display = 'block';
      setTimeout(()=>{ errorBox.style.display = 'none'; }, 7000);
    }

    async function listCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        selCam.innerHTML = '';
        cams.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          const label = d.label || `C√°mara ${i+1}`;
          opt.textContent = label;
          selCam.appendChild(opt);
        });
        if (!cams.length) showError('No se han encontrado c√°maras.');
      } catch (e) { showError(e); }
    }

    async function startStream(deviceId){
      try {
        stopStream();
        const constraints = {
          audio: false,
          video: {
            deviceId: deviceId ? { exact: deviceId } : undefined,
            facingMode: deviceId ? undefined : { ideal: 'environment' },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            frameRate: { ideal: 60, max: 60 }
          }
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        currentTrack = stream.getVideoTracks()[0];
        btnStop.disabled = false;
        btnStart.disabled = true;

        // Actualiza lista de c√°maras (ahora con labels) y selecciona la activa
        await listCameras();
        const settings = currentTrack.getSettings();
        if (settings.deviceId) selCam.value = settings.deviceId;

        // Configurar zoom si est√° soportado
        const caps = currentTrack.getCapabilities?.() || {};
        if (caps.zoom) {
          const { min, max, step } = caps.zoom;
          zoomSlider.min = min ?? 1;
          zoomSlider.max = max ?? 1;
          zoomSlider.step = step ?? 0.01;
          const cur = currentTrack.getSettings().zoom ?? 1;
          zoomSlider.value = cur;
          zoomSlider.disabled = false;
        } else {
          zoomSlider.disabled = true;
        }

        // Configurar linterna si est√° soportado
        if (caps.torch) {
          btnTorch.disabled = false;
        } else {
          btnTorch.disabled = true;
        }

        // Wake Lock para que no se apague la pantalla
        try {
          if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            document.addEventListener('visibilitychange', async () => {
              if (wakeLock !== null && document.visibilityState === 'visible') {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch {}
              }
            });
          }
        } catch {}
      } catch (e) {
        showError(e);
        btnStart.disabled = false;
        btnStop.disabled = true;
      }
    }

    function stopStream(){
      try {
        if (currentStream) {
          currentStream.getTracks().forEach(t => t.stop());
        }
      } catch {}
      currentStream = null;
      currentTrack = null;
      btnStart.disabled = false;
      btnStop.disabled = true;
      zoomSlider.disabled = true;
      btnTorch.disabled = true;
      torchOn = false;
    }

    async function toggleFullscreen(){
      try {
        if (!document.fullscreenElement) {
          await document.documentElement.requestFullscreen();
        } else {
          await document.exitFullscreen();
        }
      } catch (e) { showError(e); }
    }

    // Eventos UI
    btnStart.addEventListener('click', () => startStream(selCam.value));
    btnStop.addEventListener('click', stopStream);
    btnFS.addEventListener('click', toggleFullscreen);
    btnMirror.addEventListener('click', () => stage.classList.toggle('mirror'));
    btnFit.addEventListener('click', () => stage.classList.toggle('contain'));

    selCam.addEventListener('change', () => startStream(selCam.value));

    zoomSlider.addEventListener('input', async () => {
      if (!currentTrack) return;
      const v = Number(zoomSlider.value);
      try { await currentTrack.applyConstraints({ advanced: [{ zoom: v }] }); }
      catch (e) { showError(e); }
    });

    btnTorch.addEventListener('click', async () => {
      if (!currentTrack) return;
      torchOn = !torchOn;
      try {
        await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      } catch (e) { torchOn = !torchOn; showError(e); }
      btnTorch.textContent = torchOn ? 'üî¶ Linterna: ON' : 'üî¶ Linterna';
    });

    // Atajos
    window.addEventListener('keydown', (ev) => {
      if (ev.key === ' '){ ev.preventDefault(); (btnStop.disabled ? btnStart : btnStop).click(); }
      else if (ev.key.toLowerCase() === 'f'){ btnFS.click(); }
      else if (ev.key.toLowerCase() === 'm'){ btnMirror.click(); }
      else if (ev.key.toLowerCase() === 'c'){ btnFit.click(); }
    });

    // Ocultar cursor si no se mueve
    let idleTimer = null;
    const resetIdle = () => { document.body.classList.remove('idle'); clearTimeout(idleTimer); idleTimer = setTimeout(() => document.body.classList.add('idle'), 3000); };
    window.addEventListener('mousemove', resetIdle);
    window.addEventListener('touchstart', resetIdle);
    resetIdle();

    // Preparar
    (async function init(){
      if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
        showError('Tu navegador no soporta getUserMedia. Usa un navegador moderno (Chrome, Edge, Firefox, Safari) y conexi√≥n HTTPS/localhost.');
        return;
      }
      await listCameras();
      // Autoiniciar si hay c√°mara
      if (selCam.options.length) {
        startStream(selCam.value);
      }
      // Actualizar lista cuando haya cambios (ej. conectar c√°mara USB)
      navigator.mediaDevices.addEventListener?.('devicechange', listCameras);
    })();

    // Limpieza al salir
    window.addEventListener('beforeunload', stopStream);
  </script></body>
</html>
